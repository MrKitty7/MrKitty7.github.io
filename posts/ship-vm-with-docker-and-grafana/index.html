<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Ship VM With Docker" /><meta property="og:locale" content="en" /><meta name="description" content="Making the PERFECT Ship VM with Docker and Grafana We’ll be making a Ship VM, meaning it will store all our Docker containers, and also, we’ll setup Grafana on it to monitor all our Docker containers. Let’s get started!" /><meta property="og:description" content="Making the PERFECT Ship VM with Docker and Grafana We’ll be making a Ship VM, meaning it will store all our Docker containers, and also, we’ll setup Grafana on it to monitor all our Docker containers. Let’s get started!" /><link rel="canonical" href="https://mrkitty7.github.io/posts/ship-vm-with-docker-and-grafana/" /><meta property="og:url" content="https://mrkitty7.github.io/posts/ship-vm-with-docker-and-grafana/" /><meta property="og:site_name" content="MrKitty’s HomeLab Docs" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-25T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Ship VM With Docker" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-06-25T20:35:30+02:00","datePublished":"2022-06-25T00:00:00+02:00","description":"Making the PERFECT Ship VM with Docker and Grafana We’ll be making a Ship VM, meaning it will store all our Docker containers, and also, we’ll setup Grafana on it to monitor all our Docker containers. Let’s get started!","headline":"Ship VM With Docker","mainEntityOfPage":{"@type":"WebPage","@id":"https://mrkitty7.github.io/posts/ship-vm-with-docker-and-grafana/"},"url":"https://mrkitty7.github.io/posts/ship-vm-with-docker-and-grafana/"}</script><title>Ship VM With Docker | MrKitty's HomeLab Docs</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="MrKitty's HomeLab Docs"><meta name="application-name" content="MrKitty's HomeLab Docs"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/107936754?v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">MrKitty's HomeLab Docs</a></div><div class="site-subtitle font-italic">A Docs site for my HomeLab</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/mrkitty7" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://stackoverflow.com/users/19383594/mrkitty" aria-label="stack-overflow" > <i class="fab fa-stack-overflow"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Ship VM With Docker</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Ship VM With Docker</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1656108000" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jun 25, 2022 </em> </span> <span> Updated <em class="" data-ts="1656182130" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jun 25, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/username">MrKitty</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="706 words"> <em>3 min</em> read</span></div></div></div><div class="post-content"><h1 id="making-the-perfect-ship-vm-with-docker-and-grafana">Making the PERFECT Ship VM with Docker and Grafana</h1><p>We’ll be making a Ship VM, meaning it will store all our Docker containers, and also, we’ll setup Grafana on it to monitor all our Docker containers. Let’s get started!</p><h2 id="lets-begin-by-making-our-vm-in-proxmox"><span class="mr-2">Let’s begin by making our VM in Proxmox</span><a href="#lets-begin-by-making-our-vm-in-proxmox" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Note: You can use any hypervisor you choose.</p><p>Make your VM in Proxmox, I recommend using Ubuntu Server 20.04 as your OS.</p><h3 id="after-your-vm-has-been-created-start-it-up-click-on-the-console-and-install-ubuntu-server"><span class="mr-2">After your VM has been created, start it up. Click on the console and install Ubuntu Server.</span><a href="#after-your-vm-has-been-created-start-it-up-click-on-the-console-and-install-ubuntu-server" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>After it’s done, reboot.</p><h2 id="next-run-these-commands"><span class="mr-2">Next, run these commands:</span><a href="#next-run-these-commands" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt upgrade
</pre></table></code></div></div><p>After you update your machine, install some essential tools:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt <span class="nb">install </span>docker.io docker-compose net-tools htop python3 qemu-guest-agent <span class="nt">-y</span>
</pre></table></code></div></div><p>After that’s done, we can create a Portainer volume:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker volume create portainer_data
</pre></table></code></div></div><p>Now we can install Portainer:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>docker run <span class="nt">-d</span> <span class="nt">-p</span> 8000:8000 <span class="nt">-p</span> 9443:9443 <span class="nt">--name</span> portainer <span class="se">\</span>
    <span class="nt">--restart</span><span class="o">=</span>always <span class="se">\</span>
    <span class="nt">-v</span> /var/run/docker.sock:/var/run/docker.sock <span class="se">\</span>
    <span class="nt">-v</span> portainer_data:/data <span class="se">\</span>
    portainer/portainer-ce:2.9.3
</pre></table></code></div></div><p>Check if the container is running:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>docker ps
</pre></table></code></div></div><p>Now head over to Portainer’s web interface:</p><pre><code class="language-url">https://&lt;ipaddress&gt;:9443
</code></pre><p>Let’s start by making a folder called docker_volumes in which we’ll have all our volumes for containers.</p><h2 id="now-lets-get-grafana-loki-set-up"><span class="mr-2">Now let’s get Grafana LOKI set-up.</span><a href="#now-lets-get-grafana-loki-set-up" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>First, in docker_volume folder run these commands:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nb">mkdir </span>grafana
<span class="nb">mkdir </span>loki
<span class="nb">mkdir </span>promtail
</pre></table></code></div></div><p>Next, log in to your Portainer interface and head over to Stacks and click Add Stack. Name it ‘loki’.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3"</span>
<span class="na">networks</span><span class="pi">:</span>
  <span class="na">loki</span><span class="pi">:</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">loki</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">grafana/loki:2.4.0</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/home/serveradmin/docker_volumes/loki:/etc/loki</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">3100:3100"</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">-config.file=/etc/loki/loki-config.yml</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">loki</span>
  <span class="na">promtail</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">grafana/promtail:2.4.0</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/var/log:/var/log</span>
      <span class="pi">-</span> <span class="s">/home/serveradmin/docker_volumes/promtail:/etc/promtail</span>
    <span class="c1"># ports:</span>
    <span class="c1">#   - "1514:1514" # this is only needed if you are going to send syslogs</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">command</span><span class="pi">:</span> <span class="s">-config.file=/etc/promtail/promtail-config.yml</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">loki</span>
  <span class="na">grafana</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">grafana/grafana:latest</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1000"</span>
    <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">/home/serveradmin/docker_volumes/grafana:/var/lib/grafana</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">3000:3000"</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">loki</span>
</pre></table></code></div></div><p>Make sure to replace the user ‘serveradmin’ with your user aswell as the user id. But do not run the stack yet.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nano loki/loki-config.yml
</pre></table></code></div></div><p>Put the following config into the file:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="na">auth_enabled</span><span class="pi">:</span> <span class="no">false</span>

<span class="na">server</span><span class="pi">:</span>
  <span class="na">http_listen_port</span><span class="pi">:</span> <span class="m">3100</span>
  <span class="na">grpc_listen_port</span><span class="pi">:</span> <span class="m">9096</span>

<span class="na">common</span><span class="pi">:</span>
  <span class="na">path_prefix</span><span class="pi">:</span> <span class="s">/tmp/loki</span>
  <span class="na">storage</span><span class="pi">:</span>
    <span class="na">filesystem</span><span class="pi">:</span>
      <span class="na">chunks_directory</span><span class="pi">:</span> <span class="s">/tmp/loki/chunks</span>
      <span class="na">rules_directory</span><span class="pi">:</span> <span class="s">/tmp/loki/rules</span>
  <span class="na">replication_factor</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">ring</span><span class="pi">:</span>
    <span class="na">instance_addr</span><span class="pi">:</span> <span class="s">127.0.0.1</span>
    <span class="na">kvstore</span><span class="pi">:</span>
      <span class="na">store</span><span class="pi">:</span> <span class="s">inmemory</span>

<span class="na">schema_config</span><span class="pi">:</span>
  <span class="na">configs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">from</span><span class="pi">:</span> <span class="s">2020-10-24</span>
      <span class="na">store</span><span class="pi">:</span> <span class="s">boltdb-shipper</span>
      <span class="na">object_store</span><span class="pi">:</span> <span class="s">filesystem</span>
      <span class="na">schema</span><span class="pi">:</span> <span class="s">v11</span>
      <span class="na">index</span><span class="pi">:</span>
        <span class="na">prefix</span><span class="pi">:</span> <span class="s">index_</span>
        <span class="na">period</span><span class="pi">:</span> <span class="s">24h</span>

<span class="na">ruler</span><span class="pi">:</span>
  <span class="na">alertmanager_url</span><span class="pi">:</span> <span class="s">http://localhost:9093</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nano promtail/promtail-config.yml
</pre></table></code></div></div><p>Put the following config into the file:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="na">server</span><span class="pi">:</span>
  <span class="na">http_listen_port</span><span class="pi">:</span> <span class="m">9080</span>
  <span class="na">grpc_listen_port</span><span class="pi">:</span> <span class="m">0</span>

<span class="na">positions</span><span class="pi">:</span>
  <span class="na">filename</span><span class="pi">:</span> <span class="s">/tmp/positions.yaml</span>

<span class="na">clients</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">url</span><span class="pi">:</span> <span class="s">http://loki:3100/loki/api/v1/push</span>

<span class="c1">#scrape_configs:</span>

<span class="c1"># local machine logs</span>

<span class="c1">#- job_name: local</span>
 <span class="c1"># static_configs:</span>
 <span class="c1"># - targets:</span>
<span class="c1">#      - localhost</span>
 <span class="c1">#   labels:</span>
<span class="c1">#      job: varlogs</span>
 <span class="c1">#     __path__: /var/log/*log</span>
  
<span class="c1"># docker logs</span>
<span class="na">scrape_configs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">job_name</span><span class="pi">:</span> <span class="s">docker</span> 
    <span class="na">pipeline_stages</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">docker</span><span class="pi">:</span> <span class="pi">{}</span>
    <span class="na">static_configs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">labels</span><span class="pi">:</span>
          <span class="na">job</span><span class="pi">:</span> <span class="s">docker</span>
          <span class="na">__path__</span><span class="pi">:</span> <span class="s">/var/lib/docker/containers/*/*-json.log</span>

<span class="c1"># syslog target</span>

<span class="c1">#- job_name: syslog</span>
<span class="c1">#  syslog:</span>
<span class="c1">#    listen_address: 0.0.0.0:1514 # make sure you also expose this port on the container</span>
<span class="c1">#    idle_timeout: 60s</span>
<span class="c1">#    label_structured_data: yes</span>
<span class="c1">#    labels:</span>
<span class="c1">#      job: "syslog"</span>
<span class="c1">#  relabel_configs:</span>
<span class="c1">#    - source_labels: ['__syslog_message_hostname']</span>
<span class="c1">#      target_label: 'host'</span>
</pre></table></code></div></div><p>Now run the stack.</p><p>Install the docker plugin:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker plugin <span class="nb">install </span>grafana/loki-docker-driver:latest <span class="nt">--alias</span> loki <span class="nt">--grant-all-permissions</span>
</pre></table></code></div></div><p>Edit the docker daemon json:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>nano /etc/docker/daemon.json
</pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"log-driver"</span><span class="p">:</span><span class="w"> </span><span class="s2">"loki"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"log-opts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"loki-url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://localhost:3100/loki/api/v1/push"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"loki-batch-size"</span><span class="p">:</span><span class="w"> </span><span class="s2">"400"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl restart docker
</pre></table></code></div></div><p>Now, let’s head to the Grafana interface.</p><p>Now let’s add a new container. Uptime Kuma:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="nn">---</span>
<span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3.1"</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">uptime-kuma</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">louislam/uptime-kuma:1</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">uptime-kuma</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/home/serveradmin/docker_volumes/uptime-kuma/data:/app/data</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">3001:3001</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">security_opt</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">no-new-privileges:true</span>
</pre></table></code></div></div><p>Visit the interface at:</p><pre><code class="language-url">http://192.168.1.5:3001
</code></pre><p>to be continued</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/homelab/'>homelab</a>, <a href='/categories/machines/'>machines</a>, <a href='/categories/virtual-machines/'>virtual-machines</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/servers/" class="post-tag no-text-decoration" >servers</a> <a href="/tags/ubuntu/" class="post-tag no-text-decoration" >ubuntu</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >docker</a> <a href="/tags/grafana/" class="post-tag no-text-decoration" >grafana</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Ship+VM+With+Docker+-+MrKitty%27s+HomeLab+Docs&url=https%3A%2F%2Fmrkitty7.github.io%2Fposts%2Fship-vm-with-docker-and-grafana%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Ship+VM+With+Docker+-+MrKitty%27s+HomeLab+Docs&u=https%3A%2F%2Fmrkitty7.github.io%2Fposts%2Fship-vm-with-docker-and-grafana%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fmrkitty7.github.io%2Fposts%2Fship-vm-with-docker-and-grafana%2F&text=Ship+VM+With+Docker+-+MrKitty%27s+HomeLab+Docs" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/ship-vm-with-docker-and-grafana/">Ship VM With Docker</a><li><a href="/posts/setting-up-pterodactyl/">Setting up Pterodactyl</a><li><a href="/posts/ubuntu-resizedisk-lvm/">Ubuntu Resize Disk LVM</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/servers/">servers</a> <a class="post-tag" href="/tags/ubuntu/">ubuntu</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/gaming/">gaming</a> <a class="post-tag" href="/tags/grafana/">grafana</a> <a class="post-tag" href="/tags/pterodactyl/">pterodactyl</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/ubuntu-resizedisk-lvm/"><div class="card-body"> <em class="small" data-ts="1656021600" data-df="ll" > Jun 24, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Ubuntu Resize Disk LVM</h3><div class="text-muted small"><p> Ubuntu Resize Disk LVM When you add more space to your disk in ex. Proxmox, you need to resize it in Ubuntu. Here are the commands that can help you achieve that: First check your disk lsblk Y...</p></div></div></a></div><div class="card"> <a href="/posts/setting-up-pterodactyl/"><div class="card-body"> <em class="small" data-ts="1656108000" data-df="ll" > Jun 25, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Setting up Pterodactyl</h3><div class="text-muted small"><p> Setting up Pterodactyl We’ll be setting up Pterodactyl WITHOUT Docker, because it will be easier and will avoid issues. to be continued</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/setting-up-pterodactyl/" class="btn btn-outline-primary" prompt="Older"><p>Setting up Pterodactyl</p></a><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/username">MrKitty</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/servers/">servers</a> <a class="post-tag" href="/tags/ubuntu/">ubuntu</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/gaming/">gaming</a> <a class="post-tag" href="/tags/grafana/">grafana</a> <a class="post-tag" href="/tags/pterodactyl/">pterodactyl</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
